<!DOCTYPE html>
<html>
<head>
    <title>Shot Tracer PRO - HoughCircles</title>
    <style>
        body { margin: 0; font-family: Arial; background: #000; color: #fff; overflow: hidden; }
        #container { display: flex; max-width: 1200px; margin: auto; height: 100vh; }
        #videoPanel { flex: 1; position: relative; background: #111; }
        #video, #canvas { width: 100%; height: auto; max-height: 100vh; display: block; }
        #controls { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; }
        #traces { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; font-size: 14px; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        button { background: #333; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin: 3px; cursor: pointer; }
        input[type="checkbox"] { margin-right: 5px; transform: scale(1.2); }
        label { display: block; margin: 5px 0; cursor: pointer; }
        #status { font-weight: bold; color: #0f0; }
    </style>
</head>
<body>
    <div id="container">
        <div id="videoPanel">
            <video id="video" controls playsinline muted></video>
            <canvas id="canvas"></canvas>
            <div id="controls">
                <div style="font-weight: bold;">üéØ Shot Tracer PRO</div>
                <input type="file" id="upload" accept="video/*">
                <br>
                <label><input type="checkbox" id="trace" checked> ‚ú® Trace</label>
                <label><input type="checkbox" id="hough" checked> üîç HoughCircles</label>
                <label><input type="checkbox" id="bbox"> üì¶ Box</label>
                <button id="clear">Clear</button>
                <button id="playBtn">‚ñ∂ Play</button>
            </div>
            <div id="traces">
                <div>FPS: <span id="fps">0</span></div>
                <div>Circles: <span id="circles">0</span></div>
                <div id="status">Upload video</div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const upload = document.getElementById('upload');
        const traceCB = document.getElementById('trace');
        const houghCB = document.getElementById('hough');
        const bboxCB = document.getElementById('bbox');
        const statusEl = document.getElementById('status');
        
        let trajectory = [], isTracking = false, frameCount = 0, lastBall = null;
        let fpsCounter = { last: 0, frames: 0 };

        // üî• HOUGH CIRCLES IMPLEMENTATION (Pure JS)
        function houghCircles(imageData, minRadius = 8, maxRadius = 25) {
            const data = imageData.data;
            const w = imageData.width, h = imageData.height;
            const circles = [];
            
            // Edge detection (Canny-like)
            const edges = new Uint8Array(w * h);
            for (let i = 0; i < data.length; i += 4) {
                const x = (i / 4) % w, y = Math.floor(i / 4 / w);
                if (x === 0 || x === w-1 || y === 0 || y === h-1) continue;
                
                const idx = y * w + x;
                const r = data[i], g = data[i+1], b = data[i+2];
                const gray = 0.3*r + 0.59*g + 0.11*b;
                
                // Sobel edge detection
                const gx = -data[i-4*w] + data[i+4*w] + -2*data[i-4] + 2*data[i+4] + -data[i+4*w] + data[i-4*w];
                const gy = -data[i-w*4] + data[i+w*4] + -2*data[i-w] + 2*data[i+w] + -data[i+w*4] + data[i-w*4];
                const magnitude = Math.sqrt(gx*gx + gy*gy);
                
                edges[idx] = magnitude > 40 ? 255 : 0; // Threshold
            }
            
            // Hough voting
            for (let y = 10; y < h-10; y++) {
                for (let x = 10; x < w-10; x++) {
                    if (edges[y*w + x] === 0) continue;
                    
                    for (let r = minRadius; r <= maxRadius; r++) {
                        const thetaStep = Math.PI / 16;
                        let votes = 0;
                        
                        // Vote for circle parameters
                        for (let theta = 0; theta < 2*Math.PI; theta += thetaStep) {
                            const cx = x + r * Math.cos(theta);
                            const cy = y + r * Math.sin(theta);
                            
                            if (cx >= 0 && cx < w && cy >= 0 && cy < h && edges[Math.floor(cy)*w + Math.floor(cx)] > 200) {
                                votes++;
                            }
                        }
                        
                        if (votes > 8) { // Strong circle
                            circles.push({x, y, r, votes});
                        }
                    }
                }
            }
            
            // Non-max suppression
            return circles.sort((a,b) => b.votes - a.votes).slice(0, 3);
        }

        function processFrame() {
            if (!isTracking || video.paused) return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            let circles = [];
            if (houghCB.checked) {
                circles = houghCircles(imageData);
                document.getElementById('circles').textContent = circles.length;
            }
            
            // Pick best circle (golf ball size + brightness)
            const bestCircle = circles.find(c => {
                const x = Math.floor(c.x), y = Math.floor(c.y);
                const i = (y * canvas.width + x) * 4;
                const brightness = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                return brightness > 120 && c.r > 6 && c.r < 20;
            }) || circles[0];
            
            if (bestCircle) {
                trajectory.push({x: bestCircle.x, y: bestCircle.y, r: bestCircle.r});
                if (trajectory.length > 80) trajectory.shift();
                lastBall = bestCircle;
                statusEl.textContent = `‚úÖ ${circles.length} circles (${trajectory.length} pts)`;
            }
            
            // DRAW TRAIL
            if (traceCB.checked && trajectory.length > 1) {
                ctx.strokeStyle = '#00ff44';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00ff44';
                
                ctx.beginPath();
                ctx.moveTo(trajectory[0].x, trajectory[0].y);
                for (let i = 1; i < trajectory.length; i++) {
                    ctx.lineTo(trajectory[i].x, trajectory[i].y);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
                
                // GLOWING BALL
                ctx.fillStyle = '#ffff00';
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ffff00';
                ctx.beginPath();
                ctx.arc(lastBall.x, lastBall.y, lastBall.r + 4, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            // BOUNDING BOX
            if (bboxCB.checked && lastBall) {
                ctx.strokeStyle = '#ff00ff';
                ctx.lineWidth = 3;
                ctx.setLineDash([8, 8]);
                ctx.strokeRect(lastBall.x - lastBall.r, lastBall.y - lastBall.r, lastBall.r*2, lastBall.r*2);
                ctx.setLineDash([]);
                ctx.fillStyle = '#ff00ff';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`${Math.round(lastBall.votes)}v`, lastBall.x + 10, lastBall.y - 10);
            }
            
            frameCount++;
            fpsCounter.frames++;
            if (performance.now() - fpsCounter.last > 1000) {
                document.getElementById('fps').textContent = Math.round(fpsCounter.frames * 1000 / (performance.now() - fpsCounter.last));
                fpsCounter.frames = 0; fpsCounter.last = performance.now();
            }
            
            requestAnimationFrame(processFrame);
        }

        // EVENTS
        upload.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                trajectory = [];
                statusEl.textContent = 'Loading...';
            }
        });

        video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            statusEl.textContent = 'Ready! Click PLAY';
        });

        video.addEventListener('play', () => {
            isTracking = true;
            processFrame();
        });

        video.addEventListener('pause', () => isTracking = false);
        document.getElementById('playBtn').addEventListener('click', () => video.play());
        document.getElementById('clear').addEventListener('click', () => trajectory = []);

        video.playsInline = true;
        console.log('üöÄ HoughCircles Shot Tracer loaded!');
    </script>
</body>
</html>
